---
- name: Provision dev server
  hosts: all
  become: true
  vars:
      dev_user: dev
      work_dir: "/home/{{ dev_user }}/work"
      volume_device: ""
      anthropic_api_key: ""
      openai_api_key: ""
      git_user_name: ""
      git_user_email: ""
      golang_version: "1.24.2"
      go_install_dir: "/usr/local/go"
      rust_version: "stable"
      node_version: "22.x"
      golang_gopath: "/home/{{ dev_user }}/go"

  pre_tasks:
      # ── Wait for system readiness ──────────────────────────────────
      # cloud-init installs apt packages during boot (see cloud-init.tftpl),
      # so by the time this finishes, all base packages are already present.

      - name: Wait for cloud-init to finish
        command: cloud-init status --wait
        changed_when: false

      - name: Wait for apt lock to be released
        shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 2; done
        changed_when: false

      # ── Ensure base packages (idempotent safety net) ──────────────
      # cloud-init should have installed these already; this is a no-op fallback.

      - name: Ensure base development packages are present
        apt:
            name:
                - git
                - git-lfs
                - build-essential
                - curl
                - wget
                - unzip
                - tar
                - jq
                - vim
                - tmux
                - ripgrep
                - fd-find
                - fzf
                - direnv
                - htop
                - tree
                - make
                - gcc
                - g++
                - ca-certificates
                - gnupg
                - software-properties-common
                - pkg-config
                - libssl-dev
            state: present
            update_cache: false

      # ── Mount persistent volume ────────────────────────────────────

      - name: Wait for volume device to appear
        wait_for:
            path: "{{ volume_device }}"
            state: present
            timeout: 60
        when: volume_device != ""

      - name: Create work directory mount point
        file:
            path: "{{ work_dir }}"
            state: directory
            mode: "0755"

      - name: Mount persistent volume
        mount:
            path: "{{ work_dir }}"
            src: "{{ volume_device }}"
            fstype: ext4
            state: mounted
            opts: defaults,nofail
        when: volume_device != ""

      - name: Set work directory ownership
        file:
            path: "{{ work_dir }}"
            owner: "{{ dev_user }}"
            group: "{{ dev_user }}"
            state: directory

  tasks:
      # ── Parallel language toolchain installation ───────────────────
      # Go, Rust, and Node.js install concurrently using async.

      - name: Install Go toolchain
        shell: |
            curl -fsSL "https://go.dev/dl/go{{ golang_version }}.linux-amd64.tar.gz" -o /tmp/go.tar.gz
            rm -rf {{ go_install_dir }}
            tar -C /usr/local -xzf /tmp/go.tar.gz
            rm -f /tmp/go.tar.gz
        args:
            creates: "{{ go_install_dir }}/bin/go"
        async: 600
        poll: 0
        register: go_install

      - name: Install Rust toolchain
        become_user: "{{ dev_user }}"
        shell: |
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain {{ rust_version }}
        args:
            creates: "/home/{{ dev_user }}/.cargo/bin/rustup"
        async: 600
        poll: 0
        register: rust_install

      - name: Install Node.js via NodeSource
        shell: |
            curl -fsSL https://deb.nodesource.com/setup_{{ node_version | regex_replace('\..*', '') }}.x | bash -
            apt-get install -y nodejs
        args:
            creates: /usr/bin/node
        async: 600
        poll: 0
        register: node_install

      # ── Wait for all toolchains ────────────────────────────────────

      - name: Wait for Go installation
        async_status:
            jid: "{{ go_install.ansible_job_id }}"
        register: go_result
        until: go_result.finished
        retries: 60
        delay: 10
        when: go_install is not skipped

      - name: Wait for Rust installation
        become_user: "{{ dev_user }}"
        async_status:
            jid: "{{ rust_install.ansible_job_id }}"
        register: rust_result
        until: rust_result.finished
        retries: 60
        delay: 10
        when: rust_install is not skipped

      - name: Wait for Node.js installation
        async_status:
            jid: "{{ node_install.ansible_job_id }}"
        register: node_result
        until: node_result.finished
        retries: 60
        delay: 10
        when: node_install is not skipped

      # ── Parallel post-install tools ────────────────────────────────
      # Go dev tools, Rust crates, and npm packages install concurrently.

      - name: Create GOPATH directories
        file:
            path: "/home/{{ dev_user }}/go/{{ item }}"
            state: directory
            owner: "{{ dev_user }}"
            group: "{{ dev_user }}"
            mode: "0755"
        loop:
            - bin
            - src
            - pkg

      - name: Install Go dev tools (gopls + delve)
        become_user: "{{ dev_user }}"
        shell: |
            export GOROOT={{ go_install_dir }}
            export GOPATH=/home/{{ dev_user }}/go
            export PATH=$GOROOT/bin:$GOPATH/bin:$PATH
            go install golang.org/x/tools/gopls@latest &
            go install github.com/go-delve/delve/cmd/dlv@latest &
            wait
        args:
            creates: "/home/{{ dev_user }}/go/bin/gopls"
        async: 600
        poll: 0
        register: go_tools_install

      - name: Install cargo-binstall
        become_user: "{{ dev_user }}"
        shell: |
            source /home/{{ dev_user }}/.cargo/env
            curl -L --proto '=https' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash
        args:
            executable: /bin/bash
            creates: "/home/{{ dev_user }}/.cargo/bin/cargo-binstall"

      - name: Install Rust crates (cargo-watch)
        become_user: "{{ dev_user }}"
        shell: |
            source /home/{{ dev_user }}/.cargo/env
            cargo binstall -y cargo-watch
        args:
            executable: /bin/bash
            creates: "/home/{{ dev_user }}/.cargo/bin/cargo-watch"
        async: 600
        poll: 0
        register: rust_crates_install

      - name: Install AI agent tools (Claude Code + Codex)
        shell: npm install -g @anthropic-ai/claude-code @openai/codex
        async: 600
        poll: 0
        register: npm_tools_install

      # ── Wait for all post-install tools ────────────────────────────

      - name: Wait for Go dev tools
        become_user: "{{ dev_user }}"
        async_status:
            jid: "{{ go_tools_install.ansible_job_id }}"
        register: go_tools_result
        until: go_tools_result.finished
        retries: 60
        delay: 10
        when: go_tools_install is not skipped

      - name: Wait for Rust crates
        become_user: "{{ dev_user }}"
        async_status:
            jid: "{{ rust_crates_install.ansible_job_id }}"
        register: rust_crates_result
        until: rust_crates_result.finished
        retries: 60
        delay: 10
        when: rust_crates_install is not skipped

      - name: Wait for AI agent tools
        async_status:
            jid: "{{ npm_tools_install.ansible_job_id }}"
        register: npm_tools_result
        until: npm_tools_result.finished
        retries: 60
        delay: 10
        when: npm_tools_install is not skipped

      # ── Skills directories ────────────────────────────────────────

      - name: Create global agent skills directories
        file:
            path: "/home/{{ dev_user }}/{{ item }}"
            state: directory
            owner: "{{ dev_user }}"
            group: "{{ dev_user }}"
            mode: "0755"
        loop:
            - .claude/skills
            - .codex/skills

      # ── Environment configuration ──────────────────────────────────

      - name: Create persistent env directory on volume
        file:
            path: "{{ work_dir }}/.devenv"
            state: directory
            owner: "{{ dev_user }}"
            group: "{{ dev_user }}"
            mode: "0700"

      - name: Write API keys to persistent volume
        copy:
            content: |
                # AI agent API keys — persisted on volume across server recreations
                export ANTHROPIC_API_KEY="{{ anthropic_api_key }}"
                export OPENAI_API_KEY="{{ openai_api_key }}"
            dest: "{{ work_dir }}/.devenv/api-keys.sh"
            owner: "{{ dev_user }}"
            group: "{{ dev_user }}"
            mode: "0600"
        when: anthropic_api_key != "" or openai_api_key != ""

      - name: Configure dev user bashrc
        blockinfile:
            path: "/home/{{ dev_user }}/.bashrc"
            block: |
                # Load API keys from persistent volume
                if [ -f "{{ work_dir }}/.devenv/api-keys.sh" ]; then
                  source "{{ work_dir }}/.devenv/api-keys.sh"
                fi

                # Go environment
                export GOROOT={{ go_install_dir }}
                export GOPATH=/home/{{ dev_user }}/go
                export PATH=$GOROOT/bin:$GOPATH/bin:$HOME/.cargo/bin:$PATH

                # Default working directory
                export WORK_DIR="{{ work_dir }}"
                cd "{{ work_dir }}" 2>/dev/null || true
            marker: "# {mark} MANAGED BY ANSIBLE — dev environment"

      # ── Git configuration (single task instead of 5 round-trips) ──

      - name: Configure git settings
        become_user: "{{ dev_user }}"
        shell: |
            {% if git_user_name != "" %}
            git config --global user.name "{{ git_user_name }}"
            {% endif %}
            {% if git_user_email != "" %}
            git config --global user.email "{{ git_user_email }}"
            {% endif %}
            git config --global init.defaultBranch main
            git config --global pull.rebase true
            git config --global push.autoSetupRemote true
        changed_when: true
